name: Download localization files

on:
  workflow_dispatch: {}

jobs:
  download:
    name: Download
    runs-on: ubuntu-latest

    steps:
      # https://learn.microsoft.com/en-us/rest/api/azure/devops/git/items/get?view=azure-devops-rest-7.1&tabs=HTTP
      - run: |
          mkdir localization-files/
          curl -u ${{ secrets.ADO_USERNAME }}:${{ secrets.ADO_TOKEN }} -o localization-files/en-US.json https://dev.azure.com/bagie/Production/_apis/git/repositories/D365_CE/items?api-version=7.0\&download=true\&path=/Latest/CustomerCare_Apps/UI/Master/BotFramework-WebChat/packages/api/src/Localization/en-US.json

      - uses: actions/upload-artifact@v3
        with:
          name: localization-files
          path: localization-files/

  create-pull-request:
    name: Create pull request
    needs:
      - download
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.3.0

      - uses: actions/download-artifact@v3
        with:
          name: localization-files
          path: packages/api/src/localization

      - id: checks
        name: Check if contains new changes
        run: |
          if [ ! -z "$(git status --porcelain)" ];
          then
            echo has-changes=1 >> $GITHUB_OUTPUT
            echo branch-name=loc-`date +"%Y%m%d-%H%M%S"` >> $GITHUB_OUTPUT
          else
            echo No new changes. >> $GITHUB_STEP_SUMMARY
          fi

      - if: ${{ steps.checks.outputs.has-changes }}
        name: Create branch
        run: |
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'
          git checkout -b ${{ steps.checks.outputs.branch-name }}
          git add .
          git commit --message="Localization sync"
          git push --set-upstream origin HEAD

      - env:
          GH_TOKEN: ${{ secrets.CREATE_PR_TOKEN }}
        if: ${{ steps.checks.outputs.has-changes }}
        name: Create pull request
        run: |
          PULL_REQUEST_NUMBER=`gh api repos/${{ github.repository }}/pulls --field base=main --field head=${{ steps.checks.outputs.branch-name }} --field title="Localization sync" | jq -r '.number'`
          gh api repos/${{ github.repository }}/issues/$PULL_REQUEST_NUMBER/assignees --field assignees[]=compulim
          gh api repos/${{ github.repository }}/issues/$PULL_REQUEST_NUMBER/labels --field labels[]=area-localization
          echo Pull request created at https://github.com/${{ github.repository }}/pull/$PULL_REQUEST_NUMBER. >> $GITHUB_STEP_SUMMARY
